<!DOCTYPE html>
<html>
<head>
    <title>Cube AR Universel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.8thwall.com/web/aframe/8frame-1.1.0.min.js"></script>
    <script src="https://apps.8thwall.com/xrweb?appKey=VOTRE_CLE_API"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
        }
        button {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
        }
        #status {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="status">Déplacez votre téléphone pour détecter une surface</div>
    <a-scene
        xrweb="allowedDevices: any"
        renderer="antialias: true"
        cursor="rayOrigin: mouse; fuse: false"
        raycaster="objects: .clickable">
        
        <a-camera position="0 8 0"></a-camera>
        
        <a-entity id="surface-marker" 
                  geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.15"
                  material="color: #ffffff; shader: flat"
                  rotation="-90 0 0"
                  visible="false">
        </a-entity>
        
        <a-box id="ar-cube"
               class="clickable"
               position="0 0.5 -5"
               rotation="0 0 0"
               material="color: #4CC3D9; opacity: 0.8"
               scale="0.5 0.5 0.5"
               visible="false">
        </a-box>
        
        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
    </a-scene>

    <div class="controls">
        <button onclick="placeCube()">Placer le cube</button>
        <button onclick="rotateCube()">Tourner</button>
    </div>

    <script>
        let isRotating = false;
        
        AFRAME.registerComponent('surface-tracking', {
            init: function() {
                this.raycaster = new THREE.Raycaster();
                this.camera = document.querySelector('a-camera').object3D;
                this.marker = document.querySelector('#surface-marker').object3D;
                this.cube = document.querySelector('#ar-cube').object3D;
                
                this.el.sceneEl.addEventListener('loaded', () => {
                    this.ground = new THREE.Plane(new THREE.Vector3(0, 1, 0));
                });
            },
            
            tick: function() {
                if (!this.ground) return;
                
                this.raycaster.setFromCamera(
                    new THREE.Vector2(0, 0),
                    this.camera
                );
                
                const intersection = this.raycaster.ray.intersectPlane(
                    this.ground,
                    new THREE.Vector3()
                );
                
                if (intersection) {
                    this.marker.position.copy(intersection);
                    this.marker.visible = true;
                    document.querySelector('#status').textContent = 'Surface détectée - Cliquez pour placer le cube';
                } else {
                    this.marker.visible = false;
                    document.querySelector('#status').textContent = 'Recherche de surface...';
                }
            }
        });

        function placeCube() {
            const marker = document.querySelector('#surface-marker');
            const cube = document.querySelector('#ar-cube');
            
            if (marker.object3D.visible) {
                cube.setAttribute('position', marker.object3D.position);
                cube.setAttribute('visible', true);
            }
        }

        function rotateCube() {
            const cube = document.querySelector('#ar-cube');
            if (!isRotating && cube.getAttribute('visible')) {
                isRotating = true;
                let rotation = 0;
                const animate = () => {
                    rotation += 10;
                    cube.setAttribute('rotation', `0 ${rotation} 0`);
                    if (rotation < 360) {
                        requestAnimationFrame(animate);
                    } else {
                        isRotating = false;
                    }
                };
                animate();
            }
        }
    </script>
</body>
</html>
